<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Detector de Productos</title>
  <style>
    body { font-family: Arial,sans-serif; margin:2rem; background:#f9f9f9 }
    h1 { color:#333 }
    #top { display:flex; flex-wrap:wrap; gap:2rem; align-items:flex-start; justify-content:center }
    video,canvas { max-width:300px; border:1px solid #ccc; margin-top:1rem }
    button { margin-top:1rem; padding:0.5rem 1rem }
    #results { display:flex; flex-wrap:wrap; gap:1rem; margin-top:1.5rem }
    .product-card { background:#fff; border:1px solid #ccc; border-radius:4px; padding:1rem; width:300px }
    .product-card h3 { margin-top:0 }
    .product-card ul { padding-left:1.2rem }
  </style>
</head>
<body>
  <h1>Detector de Productos</h1>
  <header>
    <label><input type="checkbox" id="timeout-toggle" checked> Limpiar resultados automÃ¡ticamente</label>
  </header>
  <section id="info">
    <h2>Â¿CÃ³mo funciona?</h2>
    <p>Google Vision analiza la foto para localizar productos. Cada recorte se procesa con Vision, OpenAI y se busca en OpenFoodFacts.</p>
  </section>

  <div id="top">
    <div id="camera">
      <video id="video" autoplay playsinline></video><br/>
      <button id="capture-btn">ðŸ“¸ Capturar y Buscar</button>
      <button id="test-btn">ðŸ§ª Probar Imagen</button>
    </div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <div id="results"></div>

  <script>
    const video    = document.getElementById('video');
    const canvas   = document.getElementById('canvas');
    const btn      = document.getElementById('capture-btn');
    const testBtn  = document.getElementById('test-btn');
    const results  = document.getElementById('results');
    const timeoutToggle = document.getElementById('timeout-toggle');

    let resetTimer;
    function resetUI() {
      results.innerHTML = '';
    }

    function scheduleReset() {
      clearTimeout(resetTimer);
      if (timeoutToggle.checked) {
        resetTimer = setTimeout(resetUI, 10000);
      }
    }

    timeoutToggle.addEventListener('change', () => {
      if (!timeoutToggle.checked) clearTimeout(resetTimer);
    });

    navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } })
      .then(s => video.srcObject = s)
      .catch(e => alert('Error cÃ¡mara: '+e.message));

    async function upload(blob) {
      if (!blob) return alert('Error al procesar imagen');

      results.innerHTML = '<p>Procesando...</p>';

      const fd = new FormData();
      fd.append('image', blob, 'captura.jpg');

      try {
        const res = await fetch('http://localhost:5000/upload',{ method:'POST', body:fd });
        if (!res.ok) throw new Error((await res.json()).error || res.statusText);
        const d = await res.json();

        results.innerHTML = '';
        d.products.forEach((p, idx) => {
          const card = document.createElement('div');
          card.className = 'product-card';
          const barcodes = p.visionData.barcodes.map(b => `<li>${b}</li>`).join('') || '<li>â€”</li>';
          const logos = p.visionData.logos.map(l => `<li>${l.name} (${l.score.toFixed(2)})</li>`).join('') || '<li>â€”</li>';
          const textLines = p.visionData.text.split('\n').filter(Boolean).map(t => `<li>${t}</li>`).join('') || '<li>â€”</li>';
          const link = p.offLink ? `<a href="${p.offLink}" target="_blank">Ver en OpenFoodFacts</a>` : 'Sin resultados en OFF';
          card.innerHTML = `
            <h3>Producto ${idx+1}: ${p.aiResponse}</h3>
            <p>${link}</p>
            <h4>CÃ³digos de barras</h4><ul>${barcodes}</ul>
            <h4>Logos</h4><ul>${logos}</ul>
            <h4>Texto OCR</h4><ul>${textLines}</ul>
          `;
          results.appendChild(card);
        });
        scheduleReset();
      } catch(err) {
        results.innerHTML = '<p>Error</p>';
        alert('Error: '+err.message);
        scheduleReset();
      }
    }

    btn.onclick = () => {
      clearTimeout(resetTimer);
      const ctx = canvas.getContext('2d');
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      if (!canvas.width || !canvas.height) return alert('No se pudo capturar la imagen');

      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      canvas.toBlob(upload, 'image/jpeg');
    };

    testBtn.onclick = async () => {
      clearTimeout(resetTimer);
      try {
        const res = await fetch('test-image.png');
        const blob = await res.blob();
        upload(blob);
      } catch(err) {
        results.innerHTML = '<p>Error</p>';
        alert('Error: '+err.message);
        scheduleReset();
      }
    };
  </script>
</body>
</html>
