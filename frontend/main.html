<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Detector de Productos</title>
  <style>
    body { font-family: Arial,sans-serif; margin:2rem; background:#f9f9f9 }
    h1 { color:#333 }
    #top { display:flex; flex-wrap:wrap; gap:2rem; align-items:flex-start; justify-content:center }
    video,canvas { max-width:300px; border:1px solid #ccc; margin-top:1rem }
    button { margin-top:1rem; padding:0.5rem 1rem }
    #results { display:flex; flex-wrap:wrap; gap:1rem; margin-top:1.5rem }
    .product-card { background:#fff; border:1px solid #ccc; border-radius:4px; padding:1rem; width:300px }
    .product-card h3 { margin-top:0 }
    .product-card ul { padding-left:1.2rem }
    #status { margin-left:1rem; font-style:italic }
  </style>
</head>
<body>
  <h1>Detector de Productos</h1>
  <header>
    <label><input type="checkbox" id="timeout-toggle" checked> Limpiar resultados automáticamente</label>
    <p id="status"></p>
  </header>
  <section id="info">
    <h2>¿Cómo funciona?</h2>
    <p>Google Vision analiza la foto para localizar productos. Cada recorte se procesa con Vision, OpenAI y se busca en OpenFoodFacts.</p>
  </section>

  <div id="top">
    <div id="camera">
      <video id="video" autoplay playsinline></video><br/>
      <button id="capture-btn">📸 Capturar y Buscar</button>
      <button id="test-btn">🧪 Probar Imagen</button>
    </div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <div id="results"></div>

  <script>
    const video    = document.getElementById('video');
    const canvas   = document.getElementById('canvas');
    const btn      = document.getElementById('capture-btn');
    const testBtn  = document.getElementById('test-btn');
    const results  = document.getElementById('results');
    const timeoutToggle = document.getElementById('timeout-toggle');
    const status   = document.getElementById('status');

    let resetTimer;
    function resetUI() {
      results.innerHTML = '';
      status.textContent = '';
    }

    function scheduleReset() {
      clearTimeout(resetTimer);
      if (timeoutToggle.checked) {
        resetTimer = setTimeout(resetUI, 10000);
      }
    }

    timeoutToggle.addEventListener('change', () => {
      if (!timeoutToggle.checked) clearTimeout(resetTimer);
    });

    navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } })
      .then(s => video.srcObject = s)
      .catch(e => alert('Error cámara: '+e.message));

    async function upload(blob) {
      if (!blob) return alert('Error al procesar imagen');

      results.innerHTML = '';
      status.textContent = 'Analizando imagen...';

      const fd = new FormData();
      fd.append('image', blob, 'captura.jpg');

      try {
        const res = await fetch('http://localhost:5000/upload', { method:'POST', body: fd });
        if (!res.ok) throw new Error('HTTP '+res.status);

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let total = 0;
        const cards = [];
        let processed = 0;

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          for (const line of lines) {
            if (!line.trim()) continue;
            const msg = JSON.parse(line);
            if (msg.type === 'count') {
              total = msg.count;
              status.textContent = `Detectados ${total} posibles productos...`;
              for (let i = 0; i < total; i++) {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = '<p>Cargando...</p>';
                results.appendChild(card);
                cards.push(card);
              }
            } else if (msg.type === 'product') {
              processed++;
              status.textContent = `Producto ${processed}/${total} procesado`;
              const card = cards[msg.index];
              const image = msg.offImage ? `<img src="${msg.offImage}" alt="Imagen del producto" style="max-width:100%;"/>` : '';
              const link = msg.offLink ? `<a href="${msg.offLink}" target="_blank">Ver en OpenFoodFacts</a>` : '';
              card.innerHTML = `
                <h3>${msg.title}</h3>
                <p>Parámetro: ${msg.aiResponse}</p>
                ${image}
                ${link}
              `;
            } else if (msg.type === 'done') {
              status.textContent = 'Procesamiento completado';
            }
          }
        }
        scheduleReset();
      } catch (err) {
        results.innerHTML = '<p>Error</p>';
        status.textContent = 'Error';
        alert('Error: '+err.message);
        scheduleReset();
      }
    }

    btn.onclick = () => {
      clearTimeout(resetTimer);
      const ctx = canvas.getContext('2d');
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      if (!canvas.width || !canvas.height) return alert('No se pudo capturar la imagen');

      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      canvas.toBlob(upload, 'image/jpeg');
    };

    testBtn.onclick = async () => {
      clearTimeout(resetTimer);
      try {
        const res = await fetch('/examples/test-image.png');
        const blob = await res.blob();
        upload(blob);
      } catch(err) {
        results.innerHTML = '<p>Error</p>';
        alert('Error: '+err.message);
        scheduleReset();
      }
    };
  </script>
</body>
</html>
